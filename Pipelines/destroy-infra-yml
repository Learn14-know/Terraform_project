# Destroy Infrastructure Pipeline
# Manual trigger only for cost governance
trigger: none

variables:
  tf_version: '1.5.0'

stages:
- stage: TerraformDestroy
  displayName: 'Terraform Destroy Stage'
  jobs:
  - job: Destroy
    displayName: 'Destroy Environment'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UseTerraform@0
      inputs:
        terraformVersion: '$(tf_version)'

    - task: AzureCLI@2
      displayName: 'Azure Login'
      inputs:
        azureSubscription: 'terraform-spn' 
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az account show

    - script: |
        echo "Enter environment to destroy (dev or stage)"
        read ENV
        cd environments/$ENV
        terraform init
        terraform validate
        terraform destroy -var-file=terraform.tfvars -auto-approve
      displayName: 'Terraform Destroy'
